{% extends "base.html" %}

{% block content %}
<div class="container py-4">
    <h4>Kelola Akses Pengguna</h4>

    {% if messages %}
    <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
        {% for message in messages %}
            {{ message }}
        {% endfor %}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="table-responsive mt-3">
        <table id="datatable" class="table table-bordered table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Username</th>
                    <th>Email</th>
                    <th>Grup</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Aksi</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user.username }}</td>
                    <td>{{ user.email }}</td>
                    <td>
                        {% if user.groups.all %}
                            {{ user.groups.first.name }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if user.is_active %}
                            <span class="badge bg-success">Aktif</span>
                        {% else %}
                            <span class="badge bg-secondary">Nonaktif</span>
                        {% endif %}
                    </td>
                    <td>{{ user.last_login|date:"d M Y H:i" }}</td>
                    <td>
                        <form method="post" action="{% url 'update_grup_pengguna' user.id %}" class="d-inline">
                            {% csrf_token %}
                            <select name="group" class="form-select form-select-sm d-inline w-auto">
                                {% for group in groups %}
                                <option value="{{ group.name }}"
                                    {% if group in user.groups.all %}selected{% endif %}>
                                    {{ group.name }}
                                </option>
                                {% endfor %}
                            </select>
                            <button type="submit" class="btn btn-sm btn-primary">Simpan</button>
                        </form>

                        <a href="{% url 'toggle_status_user' user.id %}" class="btn btn-sm {% if user.is_active %}btn-warning{% else %}btn-success{% endif %} ms-2">
                            {% if user.is_active %}Nonaktifkan{% else %}Aktifkan{% endif %}
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- DataTables Script -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css">
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
<script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>

<script>
$(document).ready(function () {
    $('#datatable').DataTable({
        dom: 'Bfrtip',
        buttons: ['excel', 'pdf', 'print'],
        language: {
            search: "Cari:",
            lengthMenu: "Tampilkan _MENU_ entri",
            info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ data",
            paginate: {
                previous: "Sebelumnya",
                next: "Berikutnya"
            }
        }
    });
});
</script>
{% endblock %}

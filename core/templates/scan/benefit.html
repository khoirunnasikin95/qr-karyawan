{% extends 'base.html' %}

{% block content %}
<div class="text-center mb-4">
    <h5 class="fw-bold">Scan Kartu Karyawan (Benefit)</h5>
</div>

<div class="d-flex justify-content-center">
    <div id="reader" class="border rounded shadow-sm" style="width: 90vw; max-width: 400px;"></div>
</div>

<div id="result" class="mt-4 text-center d-none">
    <h5 id="nama"></h5>
    <p><strong>Departemen:</strong> <span id="departemen"></span></p>

    <!-- Notifikasi hasil scan -->
    <div class="mt-3 text-center">
        <div id="scanMessage" class="alert d-none" role="alert">
            <i id="scanIcon" class="me-2 fs-4"></i>
            <span id="scanText" class="fw-bold fs-5"></span>
        </div>
    </div>

    <div id="btnArea" class="mb-2 d-none">
        <button id="btnAmbil" class="btn btn-success">Ambil Benefit</button>
    </div>

    <button class="btn btn-outline-secondary" onclick="window.location.reload()">Scan Ulang</button>

    <hr>
    <div class="mt-3">
        <h6>Riwayat Benefit</h6>
        <ul id="riwayat" class="list-group small"></ul>
    </div>
</div>

<div id="notfound" class="mt-4 text-center d-none">
    <div class="alert alert-danger">ID tidak ditemukan atau tidak berhak mengambil benefit.</div>
    <button class="btn btn-outline-danger" onclick="window.location.reload()">Scan Ulang</button>
</div>

<!-- Bootstrap Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<!-- HTML5 QRCode Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<script>
    const hasil = document.getElementById("result");
    const notfound = document.getElementById("notfound");
    const btnArea = document.getElementById("btnArea");
    const btnAmbil = document.getElementById("btnAmbil");
    let html5QrCode = new Html5Qrcode("reader");

    function speak(text) {
        const msg = new SpeechSynthesisUtterance(text);
        msg.lang = "id-ID";
        window.speechSynthesis.speak(msg);
    }

    function showScanMessage(jenisList) {
        const alertBox = document.getElementById("scanMessage");
        const icon = document.getElementById("scanIcon");
        const text = document.getElementById("scanText");

        alertBox.classList.remove("d-none", "alert-success", "alert-danger", "alert-warning");
        icon.className = "me-2 fs-4";
        let pesan = "";

        if (jenisList.includes("telur_susu")) {
            alertBox.classList.add("alert-success");
            icon.innerText = "ðŸ¥šðŸ¥›";
            pesan = "Anda mendapatkan telur dan susu";
        } else if (jenisList.includes("susu")) {
            alertBox.classList.add("alert-success");
            icon.innerText = "ðŸ¥›";
            pesan = "Anda mendapatkan susu";
        } else if (jenisList.includes("lainnya")) {
            alertBox.classList.add("alert-success");
            icon.innerText = "ðŸŽ";
            pesan = "Anda mendapatkan benefit lainnya";
        } else {
            alertBox.classList.add("alert-warning");
            icon.classList.add("bi-exclamation-triangle-fill");
            icon.innerText = ""; // reset emoji
            pesan = "Anda tidak mendapatkan benefit";
        }

        text.innerText = pesan;
        speak(pesan);
    }

    function onScanSuccess(decodedText) {
        html5QrCode.stop().then(() => {
            fetch(`/api/benefit/${decodedText}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'eligible') {
                        hasil.classList.remove("d-none");
                        notfound.classList.add("d-none");

                        document.getElementById("nama").innerText = data.data.nama;
                        document.getElementById("departemen").innerText = data.data.departemen;

                        const jenisBenefit = data.data.jenis || [];

                        showScanMessage(jenisBenefit);

                        if (jenisBenefit.length > 0) {
                            btnArea.classList.remove("d-none");
                            btnAmbil.onclick = () => ambilBenefit(data.data.no_id, jenisBenefit);
                        } else {
                            btnArea.classList.add("d-none");
                        }

                        const ul = document.getElementById("riwayat");
                        ul.innerHTML = '';
                        const riwayat = data.data.riwayat || [];
                        if (riwayat.length > 0) {
                            riwayat.forEach(item => {
                                const li = document.createElement("li");
                                li.className = "list-group-item";
                                li.innerText = `${item.jenis} - ${item.tanggal}`;
                                ul.appendChild(li);
                            });
                        } else {
                            ul.innerHTML = '<li class="list-group-item">Belum ada riwayat.</li>';
                        }
                    } else {
                        hasil.classList.add("d-none");
                        notfound.classList.remove("d-none");
                        showScanMessage([]); // tampilkan warning
                        speak("ID tidak ditemukan atau tidak memiliki benefit");
                    }
                });
        }).catch(err => {
            console.error("Stop kamera gagal:", err);
        });
    }

    function ambilBenefit(no_id, jenisList) {
        jenisList.forEach(jenis => {
            fetch("/api/benefit/take/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: `no_id=${no_id}&jenis=${jenis}`
            })
            .then(res => res.json())
            .then(res => {
                if (res.success) {
                    alert(`Benefit ${jenis} berhasil dicatat.`);
                } else {
                    alert(res.message || `Gagal mencatat benefit ${jenis}.`);
                }
                window.location.reload();
            });
        });
    }

    Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            ).catch(err => {
                console.error("Scanner gagal dimulai:", err);
            });
        } else {
            alert("Kamera tidak ditemukan.");
        }
    }).catch(err => {
        console.error("Gagal mendapatkan kamera:", err);
    });
</script>
{% endblock %}

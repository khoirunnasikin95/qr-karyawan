{% extends 'base.html' %}
{% block content %}
<div class="text-center mb-4">
    <h5 class="fw-bold">Scan Kartu Karyawan (Benefit)</h5>
</div>

<div class="d-flex justify-content-center">
    <video id="preview" class="border rounded shadow-sm" style="width: 90vw; max-width: 400px; height: auto;"></video>
</div>

<div id="result" class="mt-4 text-center d-none">
    <h5 id="nama"></h5>
    <p><strong>Departemen:</strong> <span id="departemen"></span></p>

    <button id="btnAmbil" class="btn btn-success">Ambil Benefit</button>
    <button class="btn btn-outline-secondary ms-2" onclick="window.location.reload()">Scan Ulang</button>

    <hr>
    <div class="mt-3">
        <h6>Riwayat Benefit</h6>
        <ul id="riwayat" class="list-group small"></ul>
    </div>
</div>

<div id="notfound" class="mt-4 text-center d-none">
    <div class="alert alert-danger">ID tidak ditemukan atau tidak berhak mengambil benefit.</div>
    <button class="btn btn-outline-danger" onclick="window.location.reload()">Scan Ulang</button>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>
<script>
    const hasil = document.getElementById("result");
    const notfound = document.getElementById("notfound");
    let html5QrCode = new Html5Qrcode("reader");

    function onScanSuccess(decodedText) {
        html5QrCode.stop().then(() => {
            fetch(`/api/benefit/${decodedText}/`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'eligible') {
                        hasil.classList.remove("d-none");
                        document.getElementById("nama").innerText = data.data.nama;
                        document.getElementById("departemen").innerText = data.data.departemen;

                        document.getElementById("btnAmbil").onclick = function () {
                            ambilBenefit(data.data.no_id);
                        };

                        let riwayat = data.data.riwayat;
                        const ul = document.getElementById("riwayat");
                        ul.innerHTML = '';
                        if (riwayat.length > 0) {
                            riwayat.forEach(item => {
                                const li = document.createElement("li");
                                li.className = "list-group-item";
                                li.innerText = `${item.jenis} - ${item.tanggal}`;
                                ul.appendChild(li);
                            });
                        } else {
                            ul.innerHTML = '<li class="list-group-item">Belum ada riwayat.</li>';
                        }
                    } else {
                        notfound.classList.remove("d-none");
                    }
                });
        }).catch(err => {
            console.error("Stop kamera gagal:", err);
        });
    }

    function ambilBenefit(no_id) {
        fetch("/api/benefit/take/", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: `no_id=${no_id}&jenis=susu`
        })
        .then(res => res.json())
        .then(res => {
            if (res.success) {
                alert("Benefit berhasil dicatat.");
                window.location.reload();
            } else {
                alert(res.message || "Gagal mencatat benefit.");
            }
        });
    }

    Html5Qrcode.getCameras().then(cameras => {
        if (cameras && cameras.length) {
            html5QrCode.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            ).catch(err => {
                console.error("Scanner gagal dimulai:", err);
            });
        } else {
            alert("Kamera tidak ditemukan.");
        }
    }).catch(err => {
        console.error("Gagal mendapatkan kamera:", err);
    });
</script>
{% endblock %}
